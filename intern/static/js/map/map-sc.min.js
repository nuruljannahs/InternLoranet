marker="",map="";var jdata,arrMarker=[],markerClustersDevice=[],markerClustersFeeder=[],markerClustersGateway=[],dtfeederlog="",dtmainlog="";function streetlight(){jdata=function(){var e=null;return $.ajax({async:!1,global:!1,beforeSend:function(e){e.setRequestHeader("Authorization","Token "+tokenori)},url:"/sYE8kSrGbwM=/api/device/json",dataType:"json",success:function(t){e=t}}),e}();var e,t,a,r=parseFloat(jdata[0].latitude),n=parseFloat(jdata[0].longitude),i=document.getElementById("org").innerHTML;map=L.map("map",{zoomControl:!1,center:[-25.2702,134.2798],zoom:3,fullscreenControl:{pseudoFullscreen:!1,position:"topright"}}).setView([r,n],9),L.control.zoom({position:"bottomright"}).addTo(map),mapLink='<a href="https://openstreetmap.org">OpenStreetMap</a>',L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; "+mapLink+" loranet.my",maxZoom:19}).addTo(map),markerClustersDevice=L.markerClusterGroup({spiderfyOnMaxZoom:!0,maxZoom:10,disableClusteringAtZoom:16});var o=[];function l(l){if(l[d].organization==i||null==l[d].organization){function c(e){s(this.options.id,!1)}e=l[d].statuspower,t=l[d].alarm,a=l[d].devicestatus,sl=1==a?0==t?1==e?slgreen:slgrey:slred:slblue,(o=new L.marker([parseFloat(r),parseFloat(n)],{icon:sl,id:l[d].deviceid,name:l[d].devicename,deveui:l[d].deviceeui}).addTo(markerClustersDevice)).on("click",c);l[d].deviceid,l[d].devicename,l[d].voltage,l[d].current,l[d].activepower,l[d].datecreated;var m="<b>"+l[d].devicename+"</b>";o.bindPopup(m,{maxWidth:170}),arrMarker[d]=o}else if(1==i){function c(e){s(this.options.id,!1)}e=l[d].statuspower,t=l[d].alarm,a=l[d].devicestatus,sl=1==a?0==t?1==e?slgreen:slgrey:slred:slblue,(o=new L.marker([parseFloat(r),parseFloat(n)],{icon:sl,id:l[d].deviceid,name:l[d].devicename,deveui:l[d].deviceeui}).addTo(markerClustersDevice)).on("click",c);l[d].deviceid,l[d].devicename,l[d].voltage,l[d].current,l[d].activepower,l[d].datecreated,m="<b>"+l[d].devicename+"</b>";o.bindPopup(m,{maxWidth:170}),arrMarker[d]=o}}for(var d=0;d<jdata.length;d++)try{r=parseFloat(jdata[d].latitude),n=parseFloat(jdata[d].longitude),l(jdata)}catch(e){}function s(e,t){for(var a in arrMarker)if(arrMarker[a].options.id==e){var r=arrMarker[a]._latlng.lat,n=arrMarker[a]._latlng.lng;$("#myInput").val(arrMarker[a].options.name),$("#kadscroll").css("display","block"),$("#kad").css("display","block"),$("#searchicon").css("display","none"),$("#timeicon").css("display","inline"),longlatS(n,r,r),1==t&&arrMarker[a].openPopup()}!function(e){$.ajax({beforeSend:function(e,t){p(t.type)||this.crossDomain||e.setRequestHeader("X-CSRFToken",u)},type:"POST",url:"/sYE8kSrGbwM=/getjsondevice",data:{deviceid:e},success:function(t){for(var a in $("#devicename").html("<a href='/sYE8kSrGbwM=/device/"+t.deviceid+"'>"+t.devicename+"</a>"),$("#deviceeui").html(t.deviceeui),$("#dev_main").html(t.deviceeui),jdata)e==jdata[a].deviceid&&($("#voltage").html(jdata[a].voltage),$("#current").html(jdata[a].current),$("#power").html(jdata[a].activepower),$("#qdate").html(jdata[a].datecreated),1==jdata[a].statuspower?($("#lamp_img_on").show(),$("#lamp_img").hide()):($("#lamp_img_on").hide(),$("#lamp_img").show()),c(t));for(var r in ddata)if(e==ddata[r].pk){var n=ddata[r].fields.comment,i=ddata[r].fields.dateupdated.replace("T"," ");null!=n?($("#remark").show(),$("#remark").html(n)):$("#remark").hide(),$("#joindate").html("Join date: "+i)}}})}(e)}function c(e){$("#mainlog").DataTable().destroy(),dtmainlog=$("#mainlog").DataTable({ajax:{url:"/sYE8kSrGbwM=/jsonMaintenanceDevice/"+e.deviceeui,dataSrc:function(e){return e}},columns:[{data:"num",defaultContent:""},{data:"datecreated",defaultContent:""},{data:"description",defaultContent:""},{data:"username",defaultContent:""},{data:"img",fnCreatedCell:function(e,t,a,r,n){"-"!=a.img&&$(e).html('<img src="'+a.link+'" width="100" height="100"/><br><a href="'+a.link+'" target="_blank">'+a.img+"</a>")},defaultContent:""},{data:"",fnCreatedCell:function(e,t,a,r,n){parseInt(role)>4&&$(e).html("<button class='buttons-ok' >Delete</button>")},defaultContent:""}]}),parseInt(role)<5&&dtmainlog.columns(5).visible(!1)}function m(e,t){1==confirm("Are you sure to remove?")&&(t.remove().draw(),$.ajax({beforeSend:function(e,t){p(t.type)||this.crossDomain||e.setRequestHeader("X-CSRFToken",u)},type:"POST",url:"/sYE8kSrGbwM=/removemaintenancereport",data:{logid:e},success:function(e){console.log("Result :"+e)}}))}setInterval(function(){$.ajax({async:!0,global:!1,url:"/sYE8kSrGbwM=/devstat",success:function(e){for(var t in json=e.split(","),arrMarker)deviceeui=arrMarker[t].options.deveui,deviceeui==json[0]&&(0==json[1]?arrMarker[t].setIcon(slgrey):arrMarker[t].setIcon(slgreen))}})},1e3),map.addLayer(markerClustersDevice),$("#mainlog").on("click","tbody .buttons-ok",function(){var e=dtmainlog.row($(this).closest("tr")),t=e.data();logid=t.logid,m(logid,e)}),$("#feederlog").on("click","tbody .buttons-ok",function(){var e=dtfeederlog.row($(this).closest("tr")),t=e.data();logid=t.logid,m(logid,e)}),function(e,t){var a;function r(e){if(!e)return!1;!function(e){for(var t=0;t<e.length;t++)e[t].classList.remove("autocomplete-active")}(e),a>=e.length&&(a=0),a<0&&(a=e.length-1),e[a].classList.add("autocomplete-active")}function n(t){for(var a=document.getElementsByClassName("autocomplete-items"),r=0;r<a.length;r++)t!=a[r]&&t!=e&&a[r].parentNode.removeChild(a[r])}e.addEventListener("input",function(r){var i,o,l,d=this.value;if(n(),!d)return!1;for(a=-1,(i=document.createElement("DIV")).setAttribute("id",this.id+"autocomplete-list"),i.setAttribute("class","autocomplete-items"),this.parentNode.appendChild(i),l=0;l<t.length;l++)t[l].devicename.toUpperCase().indexOf(d.toUpperCase())>-1&&((o=document.createElement("DIV")).innerHTML="<strong>"+t[l].devicename.substr(0,d.length)+"</strong>",o.innerHTML+=t[l].devicename.substr(d.length),o.innerHTML+="<input type='hidden' value='"+t[l].devicename+","+t[l].longitude+","+t[l].latitude+","+t[l].deviceid+"'>",o.addEventListener("click",function(t){listval=this.getElementsByTagName("input")[0].value,e.value=listval.split(",",1),longitude=listval.split(",")[1],latitude=listval.split(",")[2],s(listval.split(",")[3],!0),n()}),i.appendChild(o))}),e.addEventListener("keydown",function(e){var t=document.getElementById(this.id+"autocomplete-list");t&&(t=t.getElementsByTagName("div")),40==e.keyCode?(a++,r(t)):38==e.keyCode?(a--,r(t)):13==e.keyCode&&(e.preventDefault(),a>-1&&t&&t[a].click())}),document.addEventListener("click",function(e){n(e.target)})}(document.getElementById("myInput"),jdata);var u=function(e){var t=null;if(document.cookie&&""!==document.cookie)for(var a=document.cookie.split(";"),r=0;r<a.length;r++){var n=a[r].trim();if(n.substring(0,e.length+1)===e+"="){t=decodeURIComponent(n.substring(e.length+1));break}}return t}("csrftoken");function p(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}}function feederpillar(){map.removeLayer(markerClustersDevice),map.removeLayer(markerClustersGateway),map.remove();var e,t=(e=null,$.ajax({async:!1,global:!1,url:"/sYE8kSrGbwM=/json_feeder",dataType:"json",success:function(t){e=t}}),e),a=parseFloat(t[0].feederlatitude),r=parseFloat(t[0].feederlongitude);map=L.map("map",{zoomControl:!1,center:[-25.2702,134.2798],zoom:3,fullscreenControl:{pseudoFullscreen:!1,position:"topright"}}).setView([a,r],9),mapLink='<a href="https://openstreetmap.org">OpenStreetMap</a>',L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; "+mapLink+" loranet.my",maxZoom:19}).addTo(map),markerClustersFeeder=L.markerClusterGroup();for(var n=0;n<t.length;n++){a=parseFloat(t[n].feederlatitude),r=parseFloat(t[n].feederlongitude),marker=new L.marker([parseFloat(a),parseFloat(r)],{icon:feeder,id:t[n].feederid}).addTo(markerClustersFeeder).on("click",o);var i="<b>Feeder Name:</b> "+t[n].feedername+"<br><b>Location:</b> "+t[n].map_location+"<br>";function o(e){var n=this.options.id;for(var i in t)t[i].feederid==n&&(feedername=t[i].feedername,r=t[i].feederlatitude,a=t[i].feederlongitude,locationF=t[i].map_location);$("#myInput2").val(feedername),$("#kadFeed").css("display","block"),$("#feedername").html("<a href='/sYE8kSrGbwM=/feeder/"+n+"'>"+feedername+"</a>"),$("#deviceeui").html(n),$("#longlat").html(locationF),$("#feeder_id").html(n),$("#locationF").html("  "+r.substr(0,7)+","+a.substr(0,9)),$("#lamp_imgF").html('<img width="150px" src="../static/img/feeder.png">'),$("#searchiconF").css("display","none"),$("#timeiconF").css("display","inline"),d(n)}marker.bindPopup(i,{maxWidth:170}),markerClustersFeeder.addLayer(marker),arrMarker[n]=marker}function l(e){for(var a in arrMarker)if(arrMarker[a].options.id==e){var r=arrMarker[a]._latlng.lat,n=arrMarker[a]._latlng.lng;longlatS(n,r,r)}for(var i in t)t[i].feederid==e&&(feedername=t[i].feedername);$("#kadFeed").css("display","block"),$("#feedername").html("<a href='/feeder/"+e+"'>"+feedername+"</a>"),$("#deviceeui").html(e),$("#lamp_imgF").html('<img width="150px" src="../static/img/feeder.png">'),$("#searchiconF").css("display","none"),$("#timeiconF").css("display","inline")}function d(e){$("#feederlog").DataTable().destroy(),dtfeederlog=$("#feederlog").DataTable({ajax:{url:"/sYE8kSrGbwM=/jsonMaintenanceFeeder/"+e,dataSrc:function(e){return e}},columns:[{data:"num",defaultContent:""},{data:"datecreated",defaultContent:""},{data:"description",defaultContent:""},{data:"username",defaultContent:""},{data:"img",fnCreatedCell:function(e,t,a,r,n){"-"!=a.img&&$(e).html('<img src="'+a.link+'" width="100" height="100"/><br><a href="'+a.link+'" target="_blank">'+a.img+"</a>")},defaultContent:""},{data:"",fnCreatedCell:function(e,t,a,r,n){parseInt(role)>4&&$(e).html("<button class='buttons-ok' >Delete</button>")},defaultContent:""}]}),parseInt(role)<5&&dtfeederlog.columns(5).visible(!1)}!function(e,t){var a;function r(e){if(!e)return!1;!function(e){for(var t=0;t<e.length;t++)e[t].classList.remove("autocomplete-active")}(e),a>=e.length&&(a=0),a<0&&(a=e.length-1),e[a].classList.add("autocomplete-active")}function n(t){for(var a=document.getElementsByClassName("autocomplete-items"),r=0;r<a.length;r++)t!=a[r]&&t!=e&&a[r].parentNode.removeChild(a[r])}e.addEventListener("input",function(r){var i,o,d,s=this.value;if(n(),!s)return!1;for(a=-1,(i=document.createElement("DIV")).setAttribute("id",this.id+"autocomplete-list"),i.setAttribute("class","autocomplete-items"),this.parentNode.appendChild(i),d=0;d<t.length;d++)t[d].feedername.toUpperCase().indexOf(s.toUpperCase())>-1&&((o=document.createElement("DIV")).innerHTML="<strong>"+t[d].feedername.substr(0,s.length)+"</strong>",o.innerHTML+=t[d].feedername.substr(s.length),o.innerHTML+="<input type='hidden' value='"+t[d].feedername+","+t[d].feederlongitude+","+t[d].feederlatitude+","+t[d].feederid+"'>",o.addEventListener("click",function(t){listval=this.getElementsByTagName("input")[0].value,e.value=listval.split(",")[0],longitude=listval.split(",")[1],latitude=listval.split(",")[2],l(listval.split(",")[3]),n()}),i.appendChild(o))}),e.addEventListener("keydown",function(e){var t=document.getElementById(this.id+"autocomplete-list");t&&(t=t.getElementsByTagName("div")),40==e.keyCode?(a++,r(t)):38==e.keyCode?(a--,r(t)):13==e.keyCode&&(e.preventDefault(),a>-1&&t&&t[a].click())}),document.addEventListener("click",function(e){n(e.target)})}(document.getElementById("myInput2"),t);!function(e){var t=null;if(document.cookie&&""!==document.cookie)for(var a=document.cookie.split(";"),r=0;r<a.length;r++){var n=a[r].trim();if(n.substring(0,e.length+1)===e+"="){t=decodeURIComponent(n.substring(e.length+1));break}}}("csrftoken");map.addLayer(markerClustersFeeder)}function gateway(){map.removeLayer(markerClustersDevice),map.removeLayer(markerClustersFeeder),map.remove();var e,t=(e=null,$.ajax({async:!1,global:!1,url:"/sYE8kSrGbwM=/json_gateway",dataType:"json",success:function(t){e=t}}),e),a=parseFloat(t[0].latitude),r=parseFloat(t[0].longitude);map=L.map("map",{zoomControl:!1,center:[-25.2702,134.2798],zoom:3,fullscreenControl:{pseudoFullscreen:!1,position:"topright"}}).setView([a,r],9),mapLink='<a href="https://openstreetmap.org">OpenStreetMap</a>',L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; "+mapLink+" loranet.my",maxZoom:19}).addTo(map),markerClustersGateway=L.markerClusterGroup();for(var n=0;n<t.length;n++){a=parseFloat(t[n].latitude),r=parseFloat(t[n].longitude),marker=new L.marker([parseFloat(a),parseFloat(r)],{icon:gateway});var i="<b>Gateway Name:</b> "+t[n].gatewayname+"<br><b>Gateway ID:</b> "+t[n].gatewayid+"<br>";marker.bindPopup(i,{maxWidth:170}),markerClustersGateway.addLayer(marker),arrMarker[n]=marker}map.addLayer(markerClustersGateway)}streetlight(),$("#Street").click(function(){$("#Street").addClass("xtive"),$("#Gateway").removeClass("xtive"),$("#Feeder").removeClass("xtive"),$("#src_device_id").show(),$("#src_feeder_id").hide(),clearInput(),map.removeLayer(markerClustersFeeder),map.removeLayer(markerClustersGateway),map.remove(),streetlight()}),$("#Feeder").click(function(){$("#Street").removeClass("xtive"),$("#Gateway").removeClass("xtive"),$("#Feeder").addClass("xtive"),$("#src_device_id").hide(),$("#src_feeder_id").show(),clearInput(),feederpillar()}),$("#Gateway").click(function(){$("#Street").removeClass("xtive"),$("#Gateway").addClass("xtive"),$("#Feeder").removeClass("xtive"),clearInput(),gateway()});